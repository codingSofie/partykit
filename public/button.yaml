# ===============================
# ğŸ§© Party Buzzer Web App Design
# ===============================

meta:
  version: 2.0
  author: Sofie
  purpose: æ¶ç­”æ´¾å°ç”¨ç¶²ç«™
  description: |
    ä½¿ç”¨è€…å¯è¼¸å…¥æˆ¿é–“å¯†ç¢¼é€²å…¥ã€‚ç¬¬ä¸€ä½é€²å…¥è€…è‡ªå‹•æˆç‚ºä¸»æŒäººï¼ˆHostï¼‰ã€‚
    ç”±ä¸»æŒäººæ§åˆ¶ã€Œé–‹å§‹ / é‡æ–°é–‹å§‹ã€ã€‚
    ç•¶ä¸»æŒäººé»æ“Šé–‹å§‹å¾Œï¼Œæ‰€æœ‰äººå¯æ¶ç­”ã€‚ç³»çµ±è‡ªå‹•åˆ¤å®šç¬¬ä¸€å€‹é»æ“Šè€…ä¸¦æ”¹è®Šç•«é¢é¡è‰²ã€‚
  last_updated: 2024

# ---------------------------------------------------------
# ğŸ” ç™»å…¥èˆ‡æˆ¿é–“æ§åˆ¶
# ---------------------------------------------------------
room_system:
  room_creation:
    - method: è‡ªå‹•ç”Ÿæˆæˆ¿é–“ä»£ç¢¼
      format: 6ä½æ•¸å­—æˆ–å­—æ¯çµ„åˆï¼ˆå¦‚ï¼šABC123ï¼‰
      uniqueness: ç¢ºä¿å”¯ä¸€æ€§
    - method: æˆ¿é–“å¯†ç¢¼é©—è­‰
      validation: é•·åº¦ 4-8 å­—ç¬¦ï¼Œå€åˆ†å¤§å°å¯«
      error_handling: å¯†ç¢¼éŒ¯èª¤æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
  entry_flow:
    - step: è¼¸å…¥ç©å®¶åç¨±
      field: player_name
      validation: å¿…å¡«ï¼Œé•·åº¦ 1-20 å­—ç¬¦
    - step: è¼¸å…¥æˆ¿é–“ä»£ç¢¼æˆ–å¯†ç¢¼
      field: room_code_or_password
      action: join_room(room_code_or_password, player_name)
    - condition: è‹¥æˆ¿é–“ä¸å­˜åœ¨
      result: å‰µå»ºæ–°æˆ¿é–“ï¼Œè¨­ç‚ºä¸»æŒäºº host = true
    - condition: è‹¥æˆ¿é–“å­˜åœ¨ä½†ç„¡ç©å®¶ï¼ˆç©ºæˆ¿é–“æˆ–åŸä¸»æŒäººå·²é›¢é–‹ï¼‰
      result: è¨­ç‚ºä¸»æŒäºº host = true
    - condition: è‹¥æˆ¿é–“å·²æ»¿
      result: é¡¯ç¤ºéŒ¯èª¤ "æˆ¿é–“å·²æ»¿"
    - condition: å¦å‰‡ï¼ˆæˆ¿é–“å­˜åœ¨ä¸”æœ‰å…¶ä»–ç©å®¶ï¼‰
      result: host = falseï¼ŒåŠ å…¥ç‚ºç©å®¶
  
  exit_flow:
    - step: ç”¨æˆ¶é»æ“Šã€Œé€€å‡ºæˆ¿é–“ã€æŒ‰éˆ•
      action: leave_room(player_id, room_id)
    - system_action:
      - å¾æˆ¿é–“ç©å®¶åˆ—è¡¨ä¸­ç§»é™¤è©²ç©å®¶
      - å¦‚æœè©²ç©å®¶æ˜¯ä¸»æŒäººï¼Œè½‰ç§»ä¸»æŒäººæ¬Šé™çµ¦æœ€è€çš„ç©å®¶
      - å¦‚æœæˆ¿é–“ç„¡äººï¼Œé—œé–‰æˆ¿é–“
      - å»£æ’­ç©å®¶é›¢é–‹äº‹ä»¶çµ¦æˆ¿é–“å…§å…¶ä»–ç©å®¶
    - result: è¿”å›é¦–é ï¼ˆè¼¸å…¥æˆ¿é–“å¯†ç¢¼ç‹€æ…‹ï¼‰
    - ui_state:
      - æ¸…é™¤æˆ¿é–“ç›¸é—œæ•¸æ“š
      - é¡¯ç¤ºç™»å…¥é é¢
      - é‡ç½®æ‰€æœ‰éŠæˆ²ç‹€æ…‹
    - note: é€€å‡ºæˆ¿é–“å¾Œï¼Œç”¨æˆ¶éœ€è¦é‡æ–°è¼¸å…¥æˆ¿é–“å¯†ç¢¼æ‰èƒ½å†æ¬¡åŠ å…¥
  room_settings:
    max_players: 50
    room_timeout: 30åˆ†é˜ç„¡æ´»å‹•è‡ªå‹•é—œé–‰
    password_required: false  # å¯é¸ï¼Œæˆ¿é–“å¯è¨­å¯†ç¢¼ä¿è­·
  room_states:
    - not_entered:
        description: æœªè¼¸å…¥æˆ¿é–“å¯†ç¢¼
        ui: é¡¯ç¤ºç™»å…¥é é¢ï¼ˆè¼¸å…¥ç©å®¶åç¨±å’Œæˆ¿é–“ä»£ç¢¼ï¼‰
        actions: [join_room, create_room]
    - entered:
        description: å·²è¼¸å…¥æˆ¿é–“å¯†ç¢¼ä¸¦åŠ å…¥æˆ¿é–“
        ui: é¡¯ç¤ºéŠæˆ²æˆ¿é–“é é¢
        actions: [start_round, click_buzzer, reset_round, leave_room]
        note: æ¯è¼ªéŠæˆ²çµæŸå¾Œï¼Œé»˜èªä¿æŒåœ¨ entered ç‹€æ…‹ï¼Œé™¤éç”¨æˆ¶ä¸»å‹•é€€å‡º
  roles:
    - host:
        permission:
          - å¯æŒ‰ã€Œé–‹å§‹ã€æŒ‰éˆ•
          - å¯æŒ‰ã€Œé‡æ–°é–‹å§‹ã€æŒ‰éˆ•
          - å¯æŸ¥çœ‹ç¬¬ä¸€å€‹æ¶ç­”è€…
          - å¯è¸¢å‡ºç©å®¶ï¼ˆå¯é¸åŠŸèƒ½ï¼‰
          - å¯é—œé–‰æˆ¿é–“
    - player:
        permission:
          - åªèƒ½æŒ‰ä¸­é–“æ¶ç­”æŒ‰éˆ•ï¼ˆç™½è‰²ï¼‰
          - ç„¡æ³•æ§åˆ¶éŠæˆ²ç‹€æ…‹
          - å¯é€€å‡ºæˆ¿é–“ï¼ˆä»»ä½•æ™‚å€™éƒ½å¯ä»¥ï¼‰
  connection:
    protocol: WebSocket
    reconnect:
      enabled: true
      max_attempts: 5
      backoff: exponential (1s, 2s, 4s, 8s, 16s)
    events:
      - "player_join"
      - "player_leave"
      - "host_start"
      - "player_click"
      - "round_reset"
      - "room_closed"
      - "connection_error"

# ---------------------------------------------------------
# ğŸ¨ UI çµæ§‹
# ---------------------------------------------------------
ui_layout:
  pages:
    - home:
        components:
          - player_name_input
          - room_code_input
          - join_button
          - create_room_button
          - error_message_display
    - game_room:
        components:
          - header:
              - room_code_display
              - player_count_display
              - host_indicator (if is_host)
              - exit_room_button:
                  visibility: å§‹çµ‚é¡¯ç¤ºï¼ˆæ‰€æœ‰ç‹€æ…‹ä¸‹éƒ½å¯è¦‹ï¼‰
                  position: å³ä¸Šè§’æˆ–åº•éƒ¨å›ºå®šä½ç½®
                  text: "é€€å‡ºæˆ¿é–“"
                  confirmation: å¯é¸ï¼Œé»æ“Šå¾Œå½ˆå‡ºç¢ºèªå°è©±æ¡†
                  action: leave_room()
          - control_panel (host only):
              - start_button
              - reset_button
          - buzzer_area:
              - buzzer_button
              - status_message
          - result_display:
              - winner_name
              - winner_highlight
              - reaction_time (å¯é¸)
          - player_list (å¯é¸):
              - online_players
              - click_order_display

  buzzer_button_states:
    - default: 
        color: white
        image: /asset/buttons/button_white.png
        text: "æŒ‰æˆ‘æ¶ç­”!"
        enabled: true
        animation: pulse (å¯é¸)
    - first_clicker:
        color: green
        image: /asset/buttons/button_green.png
        text: "ä½ æœ€å¿«!"
        enabled: false
        animation: success_glow
    - others_after_first:
        color: red
        image: /asset/buttons/button_red.png
        text: "å¤ªæ…¢äº†!"
        enabled: false
        animation: shake
    - disabled:
        color: gray
        image: /asset/buttons/button_white.png  # ä½¿ç”¨ç™½è‰²æŒ‰éˆ•ä½œç‚ºç¦ç”¨ç‹€æ…‹ï¼ˆæˆ–å¾…å¯¦ç¾ç°è‰²æŒ‰éˆ•ï¼‰
        text: "ç­‰å¾…ä¸­..."
        enabled: false

  responsive_design:
    breakpoints:
      - mobile: < 768px
      - tablet: 768px - 1024px
      - desktop: > 1024px
    mobile_optimization:
      - å…¨å±æŒ‰éˆ•è¨­è¨ˆ
      - ç°¡åŒ–è³‡è¨Šé¡¯ç¤º
      - è§¸æ§å„ªåŒ–

  feedback:
    visual:
      - æŒ‰éˆ•é»æ“Šå‹•ç•«
      - é¡è‰²éæ¸¡æ•ˆæœ
      - å‹è€…é«˜äº®é¡¯ç¤º
    haptic:
      - ç§»å‹•è¨­å‚™éœ‡å‹•åé¥‹ï¼ˆå¯é¸ï¼‰

# ---------------------------------------------------------
# âš™ï¸ éŠæˆ²æµç¨‹é‚è¼¯
# ---------------------------------------------------------
game_flow:
  - phase: waiting_room
    description: ç©å®¶ç­‰å¾…ä¸»æŒäººé»æ“Šã€Œé–‹å§‹ã€
    state_mapping: å°æ‡‰ state_machine ä¸­çš„ "waiting" ç‹€æ…‹
    ui_state:
      all_buttons_disabled: true
      buzzer_button_state: disabled
      message: "è«‹ç­‰å¾…ä¸»æŒäººé–‹å§‹..."
      host_controls: start_button_enabled
    validation:
      - è‡³å°‘éœ€è¦ 2 åç©å®¶æ‰èƒ½é–‹å§‹ï¼ˆå¯é¸è¦å‰‡ï¼‰
  - phase: active_round
    trigger: host_clicks_start
    state_mapping: å°æ‡‰ state_machine ä¸­çš„ "active" ç‹€æ…‹
    system_action:
      - è¨˜éŒ„æœå‹™å™¨æ™‚é–“æˆ³ä½œç‚º start_time
      - æ¸…ç©ºä¸Šä¸€è¼ªçš„é»æ“Šè¨˜éŒ„
      - å»£æ’­é–‹å§‹äº‹ä»¶çµ¦æ‰€æœ‰ç©å®¶
    ui_state:
      buzzer_enabled: true
      all_buttons_reset: white
      message: "é–‹å§‹æ¶ç­”!"
      host_controls: reset_button_disabled
    timing:
      - ä½¿ç”¨æœå‹™å™¨æ™‚é–“æˆ³ç¢ºä¿å…¬å¹³æ€§
      - è¨˜éŒ„æ¯å€‹é»æ“Šçš„æœå‹™å™¨æ™‚é–“ï¼ˆæ¯«ç§’ç²¾åº¦ï¼‰
  - phase: first_click
    trigger: first_player_click (æœå‹™å™¨åˆ¤å®š)
    system_action:
      - è¨˜éŒ„ç¬¬ä¸€å€‹é»æ“Šè€…ï¼šplayer_id, server_timestamp
      - è¨ˆç®—åæ‡‰æ™‚é–“ï¼ˆå¯é¸ï¼‰
      - ç«‹å³é–å®šæ‰€æœ‰æŒ‰éˆ•
      - å»£æ’­çµæœï¼š
        - to_first_clicker: set_button(green), show_winner_message
        - to_others: set_button(red), show_loser_message
      - è¨˜éŒ„æ‰€æœ‰é»æ“Šé †åºï¼ˆç”¨æ–¼çµ±è¨ˆï¼‰
      - ç™¼é€ round_locked äº‹ä»¶çµ¦æ‰€æœ‰ç©å®¶
    ui_lock: disable_all_buttons
    message_all: "æ¶ç­”çµæŸ!"
    state_mapping: å°æ‡‰ state_machine ä¸­çš„ "locked" ç‹€æ…‹
    anti_cheat:
      - åªæ¥å—æœå‹™å™¨æ™‚é–“æˆ³
      - å¿½ç•¥å®¢æˆ¶ç«¯ç™¼é€çš„æ™‚é–“æˆ³
      - é©—è­‰é»æ“Šæ˜¯å¦åœ¨ active_round ç‹€æ…‹
  - phase: result_display
    state_mapping: å°æ‡‰ state_machine ä¸­çš„ "result" ç‹€æ…‹
    data:
      winner_id: player_id_of_first_click
      winner_name: player_name_of_first_click
      reaction_time_ms: server_timestamp - start_time (å¯é¸)
      click_order: array of {player_id, player_name, timestamp}
    host_action:
      can_reset_round: true
      reset_button_enabled: true
    display_duration: 5ç§’ï¼ˆå¯é¸ï¼Œè‡ªå‹•é€²å…¥ä¸‹ä¸€è¼ªï¼‰
    room_persistence:
      - é»˜èªè¡Œç‚ºï¼šä¿æŒåœ¨æˆ¿é–“å…§ï¼ˆentered ç‹€æ…‹ï¼‰
      - ä¸è‡ªå‹•é€€å‡ºæˆ¿é–“
      - ç”¨æˆ¶å¿…é ˆä¸»å‹•é»æ“Šã€Œé€€å‡ºæˆ¿é–“ã€æ‰æœƒé›¢é–‹
      - é€€å‡ºå¾Œè¿”å› not_entered ç‹€æ…‹ï¼ˆè¼¸å…¥å¯†ç¢¼é é¢ï¼‰
  - phase: reset_round
    trigger: host_clicks_reset
    state_mapping: å¾ "result" æˆ– "waiting" ç‹€æ…‹è¿”å› "waiting" ç‹€æ…‹
    system_action:
      - æ¸…ç©ºæ‰€æœ‰ç‹€æ…‹
      - é‡ç½®æ‰€æœ‰ç©å®¶æŒ‰éˆ•ç‚ºç™½è‰²
      - è¿”å› waiting_room ç‹€æ…‹
    return_to_phase: waiting_room
    room_persistence:
      - ä¿æŒåœ¨æˆ¿é–“å…§ï¼ˆentered ç‹€æ…‹ï¼‰
      - ä¸é€€å‡ºæˆ¿é–“
      - æ‰€æœ‰ç©å®¶ç¹¼çºŒç•™åœ¨æˆ¿é–“ä¸­
  - phase: error_state
    triggers:
      - connection_lost
      - room_closed
      - invalid_action
    actions:
      - é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      - æä¾›é‡é€£é¸é …
      - è¿”å›é¦–é ï¼ˆå¦‚æˆ¿é–“é—œé–‰ï¼‰

# ---------------------------------------------------------
# ğŸ§  ç‹€æ…‹ç®¡ç†
# ---------------------------------------------------------
state_machine:
  room_level_states:
    - not_entered:
        description: æœªè¼¸å…¥æˆ¿é–“å¯†ç¢¼
        ui: é¡¯ç¤ºç™»å…¥é é¢ï¼ˆè¼¸å…¥ç©å®¶åç¨±å’Œæˆ¿é–“ä»£ç¢¼ï¼‰
        can_access: ä»»ä½•äººéƒ½å¯ä»¥è¨ªå•
    - entered:
        description: å·²è¼¸å…¥æˆ¿é–“å¯†ç¢¼ä¸¦åŠ å…¥æˆ¿é–“
        ui: é¡¯ç¤ºéŠæˆ²æˆ¿é–“é é¢
        can_access: éœ€è¦æˆåŠŸåŠ å…¥æˆ¿é–“
        note: é€€å‡ºæˆ¿é–“å¾Œæœƒè¿”å› not_entered ç‹€æ…‹
  
  game_level_states:
    - idle:
        description: åˆå§‹ç‹€æ…‹ï¼ŒæœªåŠ å…¥æˆ¿é–“ï¼ˆç­‰åŒæ–¼ not_enteredï¼‰
        ui: é¡¯ç¤ºç™»å…¥é é¢
        parent_state: not_entered
    - waiting:
        description: å·²åŠ å…¥æˆ¿é–“ï¼Œç­‰å¾…ä¸»æŒäººé–‹å§‹
        ui: é¡¯ç¤ºç­‰å¾…è¨Šæ¯ï¼ŒæŒ‰éˆ•ç¦ç”¨
        parent_state: entered
        exit_room_available: true
    - active:
        description: æ¶ç­”é€²è¡Œä¸­
        ui: æŒ‰éˆ•å•Ÿç”¨ï¼Œé¡¯ç¤ºé–‹å§‹è¨Šæ¯
        parent_state: entered
        exit_room_available: true
    - locked:
        description: å·²æœ‰ç¬¬ä¸€å€‹é»æ“Šè€…ï¼Œé–å®šç‹€æ…‹
        ui: æ‰€æœ‰æŒ‰éˆ•ç¦ç”¨ï¼Œé¡¯ç¤ºçµæœ
        parent_state: entered
        exit_room_available: true
    - result:
        description: é¡¯ç¤ºçµæœ
        ui: é¡¯ç¤ºå‹è€…è³‡è¨Šï¼Œä¸»æŒäººå¯é‡ç½®
        parent_state: entered
        exit_room_available: true
        note: æ¯è¼ªçµæŸå¾Œé»˜èªä¿æŒåœ¨ result ç‹€æ…‹ï¼Œä¸è‡ªå‹•é€€å‡ºæˆ¿é–“
    - error:
        description: éŒ¯èª¤ç‹€æ…‹
        ui: é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        exit_room_available: true
    - disconnected:
        description: é€£æ¥ä¸­æ–·
        ui: é¡¯ç¤ºé‡é€£é¸é …
        exit_room_available: true
  transitions:
    - from: idle
      to: waiting
      trigger: join_room_success
    - from: idle
      to: error
      trigger: join_room_failed
    - from: waiting
      to: active
      trigger: host_start
      condition: room_has_players
    - from: active
      to: locked
      trigger: first_click_received
      immediate: true
    - from: locked
      to: result
      trigger: show_result
      delay: 0ms (ç«‹å³)
    - from: result
      to: waiting
      trigger: host_reset
    - from: result
      to: active
      trigger: host_reset_and_start (å¯é¸ï¼Œä¸€éµé‡ç½®ä¸¦é–‹å§‹)
    - from: [waiting, active, locked, result]
      to: disconnected
      trigger: connection_lost
    - from: disconnected
      to: waiting
      trigger: reconnect_success
      condition: game_state.current_phase == "waiting"
    - from: disconnected
      to: active
      trigger: reconnect_success
      condition: game_state.current_phase == "active"
    - from: disconnected
      to: locked
      trigger: reconnect_success
      condition: game_state.current_phase == "locked"
      note: å¦‚æœé‡é€£æ™‚éŠæˆ²è™•æ–¼ locked ç‹€æ…‹ï¼ˆç¬¬ä¸€å€‹é»æ“Šå‰›ç™¼ç”Ÿï¼‰ï¼Œæ‡‰ç«‹å³é¡¯ç¤ºçµæœ
    - from: disconnected
      to: result
      trigger: reconnect_success
      condition: game_state.current_phase == "result"
      note: é‡é€£å¾Œæ ¹æ“šæœå‹™å™¨ç«¯å¯¦éš›éŠæˆ²ç‹€æ…‹æ¢å¾©å°æ‡‰ç‹€æ…‹
    - from: [waiting, active, locked, result]
      to: idle
      trigger: leave_room
      action:
        - æ¸…é™¤æˆ¿é–“æ•¸æ“š
        - æ–·é–‹ WebSocket é€£æ¥ï¼ˆå¯é¸ï¼‰
        - è¿”å›ç™»å…¥é é¢ï¼ˆnot_entered ç‹€æ…‹ï¼‰
      note: é€€å‡ºæˆ¿é–“å¾Œï¼Œæˆ¿é–“ç‹€æ…‹å¾ entered è®Šç‚º not_entered
    - from: any
      to: error
      trigger: system_error

# ---------------------------------------------------------
# ğŸ“¦ å‰ç«¯è³‡æ–™çµæ§‹
# ---------------------------------------------------------
frontend_data:
  user:
    id: string (UUID)
    name: string (1-20 chars)
    is_host: boolean
    joined_at: timestamp
    connection_id: string (WebSocket connection ID)
  room:
    id: string (æˆ¿é–“ä»£ç¢¼ï¼Œå¦‚ "ABC123")
    password: string | null (å¯é¸)
    created_at: timestamp
    created_by: player_id
    max_players: number (default: 50)
    players:
      - player_id: string
        player_name: string
        is_host: boolean
        joined_at: timestamp
        connection_status: "online" | "offline"
  game_state:
    current_phase: "waiting" | "active" | "locked" | "result"
    round_active: boolean
    round_number: number (ç´¯è¨ˆå›åˆæ•¸)
    first_clicker_id: string | null
    start_time: timestamp (æœå‹™å™¨æ™‚é–“ï¼Œæ¯«ç§’ç²¾åº¦)
    end_time: timestamp | null
    click_logs:
      - player_id: string
        player_name: string
        server_timestamp: number (æœå‹™å™¨æ™‚é–“æˆ³ï¼Œæ¯«ç§’)
        client_timestamp: number (å®¢æˆ¶ç«¯æ™‚é–“æˆ³ï¼Œåƒ…ç”¨æ–¼åƒè€ƒ)
        reaction_time_ms: number (è¨ˆç®—å¾—å‡º)
        order: number (é»æ“Šé †åºï¼Œ1ç‚ºæœ€å¿«)
    winner:
      player_id: string | null
      player_name: string | null
      reaction_time_ms: number | null
  ui_flags:
    buzzer_enabled: boolean
    colors: { white, green, red, gray }
    animations_enabled: boolean
  connection:
    status: "connected" | "connecting" | "disconnected" | "error"
    reconnect_attempts: number
    last_ping: timestamp

# ---------------------------------------------------------
# ğŸ”Š WebSocket Events è¨­è¨ˆ
# ---------------------------------------------------------
websocket_events:
  # å®¢æˆ¶ç«¯ -> æœå‹™å™¨
  client_to_server:
    - name: "join_room"
      payload: 
        room_code: string
        player_name: string
        password: string | null (å¯é¸)
      response: "join_room_response"
      errors:
        - "room_not_found"
        - "room_full"
        - "invalid_password"
        - "name_taken"
    
    - name: "create_room"
      payload:
        player_name: string
        password: string | null (å¯é¸)
      response: "create_room_response"
      returns: { room_code: string }
    
    - name: "start_round"
      payload: 
        room_id: string
        player_id: string (é©—è­‰æ˜¯å¦ç‚ºä¸»æŒäºº)
      response: "start_round_response"
      errors:
        - "not_host"
        - "invalid_state"
        - "insufficient_players"
    
    - name: "player_click"
      payload: 
        player_id: string
        room_id: string
        client_timestamp: number (åƒ…ç”¨æ–¼åƒè€ƒï¼Œæœå‹™å™¨æœƒè¦†è“‹)
      response: "click_response"
      errors:
        - "not_in_active_round"
        - "already_clicked"
        - "invalid_state"
    
    - name: "reset_round"
      payload: 
        room_id: string
        player_id: string (é©—è­‰æ˜¯å¦ç‚ºä¸»æŒäºº)
      response: "reset_round_response"
      errors:
        - "not_host"
        - "invalid_state"
    
    - name: "leave_room"
      payload:
        player_id: string
        room_id: string
      response: "leave_room_response"
      behavior:
        - ç”¨æˆ¶å¯ä»¥åœ¨ä»»ä½•éŠæˆ²ç‹€æ…‹ä¸‹é€€å‡ºæˆ¿é–“
        - é€€å‡ºå¾Œè¿”å›ç™»å…¥é é¢ï¼ˆnot_entered ç‹€æ…‹ï¼‰
        - éœ€è¦é‡æ–°è¼¸å…¥æˆ¿é–“å¯†ç¢¼æ‰èƒ½å†æ¬¡åŠ å…¥
      errors:
        - "player_not_in_room"
        - "invalid_room_id"
    
    - name: "ping"
      payload: {}
      response: "pong"
      purpose: ä¿æŒé€£æ¥æ´»èº

  # æœå‹™å™¨ -> å®¢æˆ¶ç«¯
  server_to_client:
    - name: "join_room_response"
      payload:
        success: boolean
        room_data: room_object | null
        user_data: user_object | null
        error: string | null
    
    - name: "player_joined"
      payload:
        player_id: string
        player_name: string
        is_host: boolean
        total_players: number
      broadcast: true (ç™¼é€çµ¦æˆ¿é–“å…§æ‰€æœ‰ç©å®¶)
    
    - name: "player_left"
      payload:
        player_id: string
        player_name: string
        total_players: number
        new_host_id: string | null (å¦‚æœä¸»æŒäººé›¢é–‹ï¼ŒæŒ‡å®šæ–°ä¸»æŒäºº)
        room_closed: boolean (å¦‚æœæˆ¿é–“ç„¡äººï¼Œæ˜¯å¦é—œé–‰)
      broadcast: true
    
    - name: "leave_room_response"
      payload:
        success: boolean
        message: string
        redirect_to: "home" | "login"
      note: æˆåŠŸé€€å‡ºå¾Œï¼Œå®¢æˆ¶ç«¯æ‡‰åˆ‡æ›åˆ°ç™»å…¥é é¢ï¼ˆnot_entered ç‹€æ…‹ï¼‰
    
    - name: "round_started"
      payload:
        room_id: string
        start_time: number (æœå‹™å™¨æ™‚é–“æˆ³)
        round_number: number
      broadcast: true
    
    - name: "click_response"
      payload:
        success: boolean
        is_first_click: boolean
        server_timestamp: number
        reaction_time_ms: number | null
        error: string | null
      note: ç™¼é€çµ¦é»æ“Šè€…æœ¬äººçš„å³æ™‚éŸ¿æ‡‰
    
    - name: "round_locked"
      payload:
        first_clicker_id: string
        first_clicker_name: string
        server_timestamp: number
      broadcast: true
      note: ç¬¬ä¸€å€‹é»æ“Šç™¼ç”Ÿå¾Œç«‹å³å»£æ’­ï¼Œé€šçŸ¥æ‰€æœ‰ç©å®¶æŒ‰éˆ•å·²é–å®šï¼ˆç¬¬ä¸€å€‹é»æ“Šè€…æŒ‰éˆ•è®Šç¶ ï¼Œå…¶ä»–äººè®Šç´…ï¼‰
    
    - name: "round_result"
      payload:
        winner_id: string
        winner_name: string
        reaction_time_ms: number
        click_logs: array (æ‰€æœ‰é»æ“Šè¨˜éŒ„)
      broadcast: true
    
    - name: "round_reset"
      payload:
        room_id: string
      broadcast: true
    
    - name: "room_closed"
      payload:
        reason: string
      broadcast: true
    
    - name: "connection_error"
      payload:
        error_code: string
        error_message: string
        reconnect_available: boolean
    
    - name: "pong"
      payload:
        server_time: number

# ---------------------------------------------------------
# ğŸ§© ç‰¹æ®Šäº’å‹•é‚è¼¯
# ---------------------------------------------------------
interaction_rules:
  - rule: "Only one winner per round"
    condition: first_click_server_timestamp == min(all_clicks_server_timestamp)
    action: set_winner(player_id)
    note: ä½¿ç”¨æœå‹™å™¨æ™‚é–“æˆ³ç¢ºä¿å…¬å¹³æ€§
  
  - rule: "Disable buttons after first click"
    action: 
      - ç«‹å³é–å®šæ‰€æœ‰æŒ‰éˆ•
      - å»£æ’­é–å®šç‹€æ…‹çµ¦æ‰€æœ‰ç©å®¶
      - å¿½ç•¥å¾ŒçºŒé»æ“Šè«‹æ±‚
    timing: æœå‹™å™¨æ”¶åˆ°ç¬¬ä¸€å€‹é»æ“Šå¾Œç«‹å³åŸ·è¡Œ
  
  - rule: "Host-only restart"
    condition: user.is_host == true AND game_state.current_phase == "result"
    action: enable_reset_button
    validation: æœå‹™å™¨ç«¯é©—è­‰ is_host ç‹€æ…‹
  
  - rule: "Prevent multi-click spam"
    client_side: 
      throttle: 500ms per player
      disable_button_after_click: true
    server_side:
      - è¨˜éŒ„æ¯å€‹ç©å®¶åœ¨æ¯è¼ªçš„é»æ“Šæ¬¡æ•¸
      - åªæ¥å—æ¯è¼ªç¬¬ä¸€æ¬¡é»æ“Š
      - å¿½ç•¥é‡è¤‡é»æ“Šè«‹æ±‚
  
  - rule: "Anti-cheat: Server-side timestamp"
    enforcement:
      - æ‰€æœ‰æ™‚é–“æˆ³ç”±æœå‹™å™¨ç”Ÿæˆ
      - å®¢æˆ¶ç«¯æ™‚é–“æˆ³åƒ…ç”¨æ–¼åƒè€ƒï¼ˆé¡¯ç¤ºç”¨ï¼‰
      - åˆ¤å®šå‹è€…æ™‚åªä½¿ç”¨æœå‹™å™¨æ™‚é–“æˆ³
      - æ‹’çµ•æœªä¾†æ™‚é–“æˆ³ï¼ˆå®¢æˆ¶ç«¯æ™‚é–“å¿«æ–¼æœå‹™å™¨ï¼‰
  
  - rule: "State validation"
    checks:
      - é»æ“Šåªèƒ½åœ¨ "active" ç‹€æ…‹ä¸‹æ¥å—
      - é–‹å§‹å›åˆåªèƒ½åœ¨ "waiting" ç‹€æ…‹ä¸‹åŸ·è¡Œ
      - é‡ç½®å¯ä»¥åœ¨ "waiting" æˆ– "result" ç‹€æ…‹ä¸‹åŸ·è¡Œï¼ˆwaiting ç‹€æ…‹é‡ç½®ç‚ºå®‰å…¨æªæ–½ï¼Œresult ç‹€æ…‹é‡ç½®ç‚ºæ­£å¸¸æµç¨‹ï¼‰
      - æ‹’çµ•ç„¡æ•ˆç‹€æ…‹è½‰æ›
  
  - rule: "Host transfer on disconnect"
    condition: host é›¢é–‹æˆ–æ–·ç·š
    action:
      - é¸æ“‡æˆ¿é–“å…§æœ€è€çš„ç©å®¶ä½œç‚ºæ–°ä¸»æŒäºº
      - å»£æ’­ä¸»æŒäººè®Šæ›´é€šçŸ¥
      - å¦‚æœæˆ¿é–“ç„¡äººï¼Œé—œé–‰æˆ¿é–“
  
  - rule: "Room auto-cleanup"
    condition: æˆ¿é–“ç„¡æ´»å‹•è¶…é 30 åˆ†é˜
    action:
      - é—œé–‰æˆ¿é–“
      - é€šçŸ¥æ‰€æœ‰ç©å®¶
      - æ¸…ç†è³‡æº
  
  - rule: "Concurrent click handling"
    scenario: å¤šå€‹ç©å®¶å¹¾ä¹åŒæ™‚é»æ“Šï¼ˆ< 10ms å·®ç•°ï¼‰
    handling:
      - ä½¿ç”¨æœå‹™å™¨æ¥æ”¶é †åºåˆ¤å®š
      - æˆ–ä½¿ç”¨æ›´ç²¾ç¢ºçš„æ™‚é–“æˆ³ï¼ˆå¾®ç§’ç´šï¼‰
      - è¨˜éŒ„æ‰€æœ‰æ¥è¿‘çš„é»æ“Šæ™‚é–“å·®

# ---------------------------------------------------------
# ğŸ’¾ è³‡æºæª”æ¡ˆ
# ---------------------------------------------------------
assets:
  buttons:
    - white: /asset/buttons/button_white.png
    - green: /asset/buttons/button_green.png
    - red: /asset/buttons/button_red.png
    # gray: /asset/buttons/button_gray.png  # å¾…å¯¦ç¾ï¼Œç›®å‰ä½¿ç”¨ç™½è‰²æŒ‰éˆ•ä½œç‚ºç¦ç”¨ç‹€æ…‹
  icons:
    - host: /asset/icons/host.png
    - player: /asset/icons/player.png
    # trophy: /asset/icons/trophy.png  # å¾…å¯¦ç¾
    # clock: /asset/icons/clock.png  # å¾…å¯¦ç¾
  # images:
    # background: /asset/images/background.jpg  # å¾…å¯¦ç¾
    # logo: /asset/images/logo.png  # å¾…å¯¦ç¾

# ---------------------------------------------------------
# ğŸ”’ å®‰å…¨æ€§è€ƒé‡
# ---------------------------------------------------------
security:
  input_validation:
    - player_name: éæ¿¾ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ XSS
    - room_code: åªå…è¨±å­—æ¯æ•¸å­—
    - password: é•·åº¦é™åˆ¶ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£
  rate_limiting:
    - join_room: æ¯ IP æ¯åˆ†é˜æœ€å¤š 10 æ¬¡
    - player_click: æ¯ç©å®¶æ¯è¼ªæœ€å¤š 1 æ¬¡
    - create_room: æ¯ IP æ¯å°æ™‚æœ€å¤š 5 æ¬¡
  authentication:
    - ä½¿ç”¨ session token æˆ– JWT
    - WebSocket é€£æ¥é©—è­‰
    - é˜²æ­¢æœªæˆæ¬Šæ“ä½œ
  data_protection:
    - ä¸è¨˜éŒ„æ•æ„Ÿè³‡è¨Š
    - æˆ¿é–“æ•¸æ“šå®šæœŸæ¸…ç†
    - éµå®ˆéš±ç§æ”¿ç­–

# ---------------------------------------------------------
# ğŸ“Š æ€§èƒ½å„ªåŒ–
# ---------------------------------------------------------
performance:
  frontend:
    - åœ–ç‰‡æ‡¶åŠ è¼‰
    - æŒ‰éˆ•ç‹€æ…‹å¿«å–
    - æ¸›å°‘é‡æ¸²æŸ“
  backend:
    - WebSocket é€£æ¥æ± ç®¡ç†
    - æˆ¿é–“ç‹€æ…‹è¨˜æ†¶é«”å¿«å–
    - å®šæœŸæ¸…ç†ç©ºæˆ¿é–“
    - ä½¿ç”¨ Redis åšç‹€æ…‹å…±äº«ï¼ˆå¦‚å¤šæœå‹™å™¨éƒ¨ç½²ï¼‰
  network:
    - äº‹ä»¶æ‰¹é‡ç™¼é€ï¼ˆå¦‚éœ€è¦ï¼‰
    - å£“ç¸® WebSocket è¨Šæ¯
    - å¿ƒè·³æ©Ÿåˆ¶å„ªåŒ–

# ---------------------------------------------------------
# ğŸ§ª æ¸¬è©¦å ´æ™¯
# ---------------------------------------------------------
test_scenarios:
  - scenario: "å–®äººå‰µå»ºæˆ¿é–“ä¸¦é–‹å§‹"
    steps: [create_room, start_round, click_button]
  - scenario: "å¤šäººåŒæ™‚é»æ“Š"
    steps: [join_room(3_players), start_round, simultaneous_clicks]
  - scenario: "ä¸»æŒäººæ–·ç·šæ¢å¾©"
    steps: [host_disconnect, reconnect, verify_host_status]
  - scenario: "æˆ¿é–“æ»¿å“¡è™•ç†"
    steps: [fill_room_to_max, attempt_join, verify_rejection]
  - scenario: "ç„¡æ•ˆç‹€æ…‹è½‰æ›"
    steps: [try_invalid_actions, verify_error_handling]

# ---------------------------------------------------------
# ğŸ“ å¾…å¯¦ç¾åŠŸèƒ½ï¼ˆå¯é¸ï¼‰
# ---------------------------------------------------------
future_features:
  - çµ±è¨ˆåŠŸèƒ½ï¼šç©å®¶å‹ç‡ã€å¹³å‡åæ‡‰æ™‚é–“
  - æ’è¡Œæ¦œï¼šæˆ¿é–“å…§æˆ–å…¨å±€
  - è‡ªè¨‚ä¸»é¡Œï¼šé¡è‰²
  - è§€æˆ°æ¨¡å¼ï¼šåªè§€çœ‹ï¼Œä¸åƒèˆ‡
  - æˆ¿é–“æ­·å²è¨˜éŒ„
  - ç§»å‹•ç«¯ App
  - å¤šèªè¨€æ”¯æ´
